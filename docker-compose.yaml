# Определение якоря (anchor) под названием service-backend-common, который содержит общие настройки
# для всех backend сервисов. Использование якоря позволяет избежать дублирования кода.
x-service-backend-common: &service-backend-common
  # Инструкции для сборки образа контейнера
  build:
    dockerfile: Dockerfile        # Указывает, что для сборки будет использоваться файл Dockerfile
    context: ./backend          # Контекст сборки - директория ./backend, в которой находится Dockerfile
  restart: always                # Политика перезапуска: контейнер будет автоматически перезапускаться при остановке
  env_file:                     # Список файлов с переменными окружения
    - .env                     # Подключает переменные из файла .env в корне проекта
  volumes:                     # Определение томов (связывание директорий хоста и контейнера)
    - ./backend/app:/app      # Привязка локальной директории ./backend/app к /app внутри контейнера
                             # Это позволяет изменения в коде сразу отражаться в контейнере без пересборки
  command:                     # Команда, которая будет выполняться при запуске контейнера
    sh -c "uvicorn main:app --port 12321 --host 0.0.0.0 --reload"
                             # Запускает uvicorn сервер с приложением main:app на порту 12321,
                             # слушает все сетевые интерфейсы (0.0.0.0) и включает режим перезагрузки при изменении кода
  networks:                    # Список сетей, к которым будет подключен контейнер
    - main_network            # Подключение к сети main_network

services:                     # Основной раздел, содержащий определения всех сервисов

  documentation:             # Сервис для запуска сервера документации
    image: squidfunk/mkdocs-material:latest  # Использует готовый образ mkdocs-material для создания документации
    container_name: mkdocs  # Задает фиксированное имя контейнера
    hostname: mkdocs       # Устанавливает hostname внутри контейнера
    command: serve --dev-addr=0.0.0.0:8010 --watch-theme
                          # Команда запуска сервера документации: слушает на всех интерфейсах порт 8010
                          # и отслеживает изменения в теме документации
    restart: unless-stopped  # Перезапуск контейнера, кроме случаев, когда он был явно остановлен
    ports:                  # Проброс портов между хостом и контейнером
      - "8010:8010"       # Порт 8010 на хосте перенаправляется на порт 8010 в контейнере
    volumes:               # Привязка локальной директории с исходниками документации
      - ./documentation:/docs  # Локальная папка ./documentation монтируется в /docs внутри контейнера
    profiles:              # Профиль, при котором будет запускаться сервис
      - docs              # Сервис будет запускаться только при указании профиля "docs"

  backend1:                  # Первый экземпляр backend сервиса
    <<: *service-backend-common  # Подстановка всех настроек из якоря service-backend-common
    container_name: backend1    # Уникальное имя для первого экземпляра
    hostname: backend1         # Имя хоста внутри контейнера
    ports:                    # Проброс портов для этого экземпляра
      - "12345:12321"       # Локальный порт 12345 перенаправляется на внутренний порт 12321

  backend2:                  # Второй экземпляр backend сервиса
    <<: *service-backend-common  # Использует те же общие настройки, что и backend1
    container_name: backend2    # Уникальное имя для второго экземпляра
    hostname: backend2         # Имя хоста внутри контейнера
    ports:                    # Проброс портов для второго экземпляра
      - "12346:12321"       # Локальный порт 12346 перенаправляется на внутренний порт 12321

  nginx:                     # Сервис веб-сервера Nginx в качестве прокси-сервера
    image: nginx:alpine     # Использует облегченный образ nginx на базе Alpine Linux
    container_name: nginx  # Фиксированное имя контейнера
    restart: always        # Автоматический перезапуск при остановке
    ports:                 # Проброс портов
      - "80:80"           # Порт 80 хоста перенаправляется на порт 80 контейнера (стандартный HTTP порт)
    networks:              # Подключение к сети
      - main_network     # Подключение к той же сети, что и backend сервисы
    volumes:               # Привязка конфигурационного файла Nginx
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
                           # Локальный файл конфигурации nginx.conf заменяет стандартный файл конфигурации

networks:                    # Определение пользовательских сетей
  main_network:             # Имя сети
    driver: bridge         # Тип сети - bridge (мостовая сеть), стандартный тип для изоляции контейнеров