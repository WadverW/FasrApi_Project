# Определяем upstream — группу серверов (балансировка нагрузки)
upstream loadbalancer {
    server backend1:12321 weight=5;   # Первый backend-сервис (контейнер backend1), порт 12321
    server backend2:12321 weight=5;   # Второй backend-сервис (контейнер backend2), порт 12321
}

server {
    listen 80;               # Слушать входящие HTTP-запросы на порту 80
    listen [::]:80;          # Слушать IPv6-подключения на порту 80

    server_tokens off;       # Отключить показ версии Nginx в заголовках (безопасность)
    charset utf-8;           # Кодировка по умолчанию — UTF-8

    # Обработка запроса к корню сайта http://domain/
    location = / {
        return 301 /api/docs;    # Редирект на Swagger UI FastAPI
    }

    # Все запросы, начинающиеся с /api
    location /api {
        proxy_pass http://loadbalancer;
        # Проброс запроса в группу backend-сервисов (round-robin балансировка)

        # Передаём корректные заголовки
        proxy_set_header Host $http_host;                   # Исходный домен клиента
        proxy_set_header X-Real-IP $remote_addr;            # IP клиента
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Цепочка IP-адресов
        proxy_set_header X-Forwarded-Proto $scheme;         # http / https

        # Таймауты для подключения и передачи данных
        proxy_connect_timeout 60s;   # Таймаут соединения с backend
        proxy_send_timeout 60s;      # Таймаут отправки данных к backend
        proxy_read_timeout 60s;      # Таймаут чтения ответа backend
        send_timeout 60s;            # Таймаут отправки клиенту

        # Настройки для WebSocket / HTTP/1.1
        proxy_http_version 1.1;              # Включаем HTTP/1.1 (нужно для WebSocket)
        proxy_set_header Upgrade $http_upgrade;  # Разрешаем WebSocket upgrade
        proxy_set_header Connection "upgrade";   # Сопутствующий заголовок

        proxy_set_header Host $host;          # Устанавливаем Host ещё раз (дублирование допустимо)
    }
}