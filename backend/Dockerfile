FROM python:3.12-slim

WORKDIR /app

ENV POETRY_NO_INTERACTION=1
# Обновление списка пакетов и установка минимально необходимых системных зависимостей
RUN apt-get update \
    && apt-get install -y --no-install-recommends make \
    && rm -rf /var/lib/apt/lists/*

# Установка и обновление pip, установка Poetry без создания виртуального окружения
RUN pip install --upgrade pip \
    && pip install --no-cache-dir poetry \
    && poetry config virtualenvs.create false

# Копирование файлов, определяющих зависимости проекта
# Эти файлы копируются отдельно от основного кода, чтобы обеспечить эффективное кэширование слоев:
# если зависимости не изменились, слой с их установкой не будет пересоздаваться
COPY pyproject.toml poetry.lock /app/

# Установка всех зависимостей проекта, указанных в pyproject.toml и poetry.lock
# Флаги:
# --no-ansi: отключает цветной вывод для более чистого лога сборки
# --no-root: устанавливает только зависимости, не устанавливая сам проект из текущей директории
# --no-interaction: выполняет установку без интерактивного ввода, что необходимо для автоматизированной сборки
RUN poetry install --no-ansi --no-root --no-interaction

# Копирование всего содержимого приложения в рабочую директорию контейнера
# Этот шаг выполняется после установки зависимостей, чтобы изменения в коде приложения
# не приводили к пересозданию слоя с установленными зависимостями
COPY . /app/